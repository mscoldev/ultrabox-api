{"version":3,"file":"stages.js","names":["_","require","PjAcceptance","updateDynamicAcceptance","_id","signatory","readAcceptanceById","data","console","log","getLastStageName","lastStage","updateStepOne","$set","contractor","$push","stage","name","completed","setAcceptanceById","updatedAcceptance","updateStepTwo","client","typeAcceptance","updateStepThree","result","update","findByIdAndUpdate","updateAcceptance","boom","notFound","findById","acceptance","findSomeStageComplete","someStageName","existingStageComplete","some","stageSome","updateSelectionStage","confirmStage","stages","orderBy","length","module","exports"],"sources":["../../../../src/helpers/validators/projects/stages.js"],"sourcesContent":["const _ = require('lodash');\nconst PjAcceptance = require('../../../models/projects/acceptance.model');\n\n\nconst updateDynamicAcceptance = async (_id, signatory) => {\n  //Obtener los datos del acta\n  try {\n    //Consultar registro\n    const data = await readAcceptanceById(_id);\n    console.log({ data });\n    //Ultimo estado reportado\n    const lastStage = await getLastStageName(data);\n    console.log({ lastStage });\n    //Evaluar los Stage y actualizar según el Stage\n    var updatedAcceptance;\n    switch (lastStage) {\n      case 'new':\n        const updateStepOne = {\n          $set: {\n            'signatory.contractor': signatory.contractor\n          },\n          $push: {\n            stage: {\n              name: 'signedByContractor',\n              completed: true\n            }\n          }\n        }\n        console.log({ updateStepOne });\n        updatedAcceptance = await setAcceptanceById(_id, updateStepOne)\n        console.log({ updatedAcceptance });\n        //Envía un correo al cliente con los datos para actualizar\n        break;\n      case \"signedByContractor\":\n        const updateStepTwo = {\n          $set: {\n            'signatory.client': signatory.client\n          },\n          $push: {\n            stage: {\n              name: 'signedByClient',\n              completed: true\n            }\n          }\n        }\n\n        updatedAcceptance = await setAcceptanceById(_id, updateStepTwo)\n\n        //Recibe la firma por parte del cliente y cambia el estado a \"signClient\"\n        if (data.typeAcceptance === 'Parcial') {\n          //El estado se mantiene igual\n          //Se envía correo al gerente de proyecto del contractor para aceptación final.\n        } else {\n          //Se empuja el estado de cerrado.\n          const updateStepThree = {\n            $push: {\n              stage: {\n                name: 'closed',\n                completed: true\n              }\n            }\n          }\n          updatedAcceptance = await setAcceptanceById(_id, updateStepThree)\n        }\n        break;\n      case \"signedByClient\":\n        //Se debe enviar una aceptación de los pendientes\n        const updateStepThree = {\n          $push: {\n            stage: {\n              name: 'closed',\n              completed: true\n            }\n          }\n        }\n\n        updatedAcceptance = await setAcceptanceById(_id, updateStepThree)\n\n        break;\n      default:\n        console.log(\"No se encontró ningún stage con ese nombre\");\n        result = \"No se encontró ningún stage con ese nombre\"\n    }\n    return updatedAcceptance;\n  } catch (err) {\n    return err\n  }\n}\n\nconst setAcceptanceById = async (_id, update) => {\n  try {\n    console.log(`id para setAccep ${_id}`);\n    const updateAcceptance = await PjAcceptance\n      .findByIdAndUpdate(_id, update, { new: true });\n    if (updateAcceptance != null) {\n      return updateAcceptance;\n    } else {\n      throw boom.notFound(`Oops!, acta con _id:${_id}, no encontrada`)\n    }\n  } catch (err) {\n    return err;\n  }\n}\n\n\nconst readAcceptanceById = async (_id) => {\n  try {\n    const acceptance = await PjAcceptance\n      .findById(_id);\n    if (acceptance != null) {\n      return acceptance;\n    } else {\n      throw boom.notFound(`Oops!, acta con _id:${_id}, no encontrada`)\n    }\n  } catch (err) {\n    return err;\n  }\n}\n\nconst findSomeStageComplete = async (data, someStageName) => {\n  // const data = await readAcceptanceById(_id);\n  const existingStageComplete = data.stage.some(stageSome => stageSome.name === someStageName && stageSome.completed === true)\n  console.log(`Se encontró el estado ${someStageName} completo en el array`);\n  const result = existingStageComplete === true ? someStageName : false;\n  return result;\n}\n\nconst updateSelectionStage = async (_id, stage) => {\n  //Obtener los datos de la base datos por medio del _id\n  const data = await readAcceptanceById(_id);\n  //Identifica si el registro cumple con el estado buscado\n  const confirmStage = await findSomeStageComplete(data, stage);\n  return confirmStage;\n}\n\nconst getLastStageName = async (data) => {\n  const stages = _.orderBy(data.stage, ['date'], ['desc']);\n  return stages.length > 0 ? stages[0].name : null;\n}\n\n\nconst data = {\n  \"_id\": {\n    \"$oid\": \"643c3c15ae1896e1e634dbb7\"\n  },\n  \"_codeProjectERP\": \"PJ2203-0112\",\n  \"_idProjectERP\": 32,\n  \"dateAcceptance\": {\n    \"$date\": \"2023-01-28T01:00:00Z\"\n  },\n  \"serviceObject\": \"Asistencia tecnica para la instalacion de 5 alarmas\",\n  \"dateInit\": {\n    \"$date\": \"2023-01-28T01:00:00Z\"\n  },\n  \"dateEnd\": {\n    \"$date\": \"2023-01-28T01:00:00Z\"\n  },\n  \"erpRef\": {\n    \"client\": {\n      \"purchaseOrder\": \"oc123456789\"\n    },\n    \"own\": {\n      \"proposal\": \"OF12334567890\"\n    }\n  },\n  \"client\": {\n    \"company\": \"ULTRACEM\",\n    \"Name\": \"Pedro Perez\",\n    \"Position\": \"Jefe de Compras\",\n    \"Email\": \"perdro.perez@prueba.com\"\n  },\n  \"controller\": {\n    \"Position\": \"No especificado\"\n  },\n  \"contractor\": {\n    \"Name\": \"Pedro Perez\",\n    \"Position\": \"Jefe de Compras\",\n    \"Email\": \"perdro.perez@prueba.com\"\n  },\n  \"deliverables\": [{\n    \"_id\": \"uuid\",\n    \"description\": \"Este es entregable 1\",\n    \"compliance\": 100,\n    \"accepted\": true\n  },\n  {\n    \"_id\": \"uuid\",\n    \"description\": \"Este es entregable 2\",\n    \"compliance\": 100,\n    \"accepted\": true\n  }\n  ],\n  \"citySign\": \"Barranquilla\",\n  \"officeSign\": \"el cliente\",\n  \"serviceValue\": 5,\n  \"recommendations\": \"Estas son nuestras recomendaciones\",\n  \"typeAcceptance\": \"Total\",\n  \"stage\": [{\n    \"name\": \"new\",\n    \"date\": {\n      \"$date\": \"2023-04-16T18:19:01.177Z\"\n    },\n    \"completed\": false,\n    \"_id\": {\n      \"$oid\": \"643c3c15ae1896e1e634dbb8\"\n    }\n  },\n  {\n    \"name\": \"rejected\",\n    \"date\": {\n      \"$date\": \"2023-04-16T18:19:01.177Z\"\n    },\n    \"completed\": true,\n    \"_id\": {\n      \"$oid\": \"643c3c15ae1896e1e634dbb8\"\n    }\n  }\n  ],\n  \"_idFiles\": [],\n  \"dateSign\": {\n    \"$date\": \"2023-04-16T18:19:01.186Z\"\n  },\n  \"rejectedMessage\": [],\n  \"createdAt\": {\n    \"$date\": \"2023-04-16T18:19:01.191Z\"\n  },\n  \"updatedAt\": {\n    \"$date\": \"2023-04-16T18:19:01.191Z\"\n  }\n}\n\n\nmodule.exports = { updateDynamicAcceptance, setAcceptanceById, findSomeStageComplete, getLastStageName }"],"mappings":"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"}