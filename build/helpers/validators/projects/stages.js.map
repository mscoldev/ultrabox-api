{"version":3,"file":"stages.js","names":["_","require","PjAcceptance","updateDynamicAcceptance","_id","signatory","readAcceptanceById","data","console","log","getLastStageName","lastStage","updateStepOne","contractor","$push","stage","name","completed","setAcceptanceById","updatedAcceptance","updateStepTwo","client","typeAcceptance","updateStepThree","result","update","findByIdAndUpdate","updateAcceptance","boom","notFound","findById","acceptance","findSomeStageComplete","someStageName","existingStageComplete","some","stageSome","updateSelectionStage","confirmStage","stages","orderBy","length","module","exports"],"sources":["../../../../src/helpers/validators/projects/stages.js"],"sourcesContent":["const _ = require('lodash');\nconst PjAcceptance = require('../../../models/projects/acceptance.model');\n\n\nconst updateDynamicAcceptance = async (_id, signatory) => {\n    //Obtener los datos del acta\n    try {\n        //Consultar registro\n        const data = await readAcceptanceById(_id);\n        console.log({ data });\n        //Ultimo estado reportado\n        const lastStage = await getLastStageName(data);\n        console.log({ lastStage });\n        //Evaluar los Stage y actualizar según el Stage\n        var updatedAcceptance;\n        switch (lastStage) {\n            case 'new':\n                const updateStepOne = {\n                    signatory: {\n                        contractor: signatory.contractor\n                    },\n                    $push: {\n                        stage: {\n                            name: 'signedByContractor',\n                            completed: true\n                        }\n                    }\n                }\n                console.log({ updateStepOne });\n                updatedAcceptance = await setAcceptanceById(_id, updateStepOne)\n                console.log({ updatedAcceptance });\n                //Envía un correo al cliente con los datos para actualizar\n                break;\n            case \"signedByContractor\":\n                const updateStepTwo = {\n                    signatory: {\n                        client: signatory.client\n                    },\n                    $push: {\n                        stage: {\n                            name: 'signedByClient',\n                            completed: true\n                        }\n                    }\n                }\n\n                updatedAcceptance = await setAcceptanceById(_id, updateStepTwo)\n\n                //Recibe la firma por parte del cliente y cambia el estado a \"signClient\"\n                if (data.typeAcceptance === 'Parcial') {\n                    //El estado se mantiene igual\n                    //Se envía correo al gerente de proyecto del contractor para aceptación final.\n                } else {\n                    //Se empuja el estado de cerrado.\n                    const updateStepThree = {\n                        $push: {\n                            stage: {\n                                name: 'closed',\n                                completed: true\n                            }\n                        }\n                    }\n                    updatedAcceptance = await setAcceptanceById(_id, updateStepThree)\n                }\n                break;\n            case \"signedByClient\":\n                //Se debe enviar una aceptación de los pendientes\n                const updateStepThree = {\n                    $push: {\n                        stage: {\n                            name: 'closed',\n                            completed: true\n                        }\n                    }\n                }\n\n                updatedAcceptance = await setAcceptanceById(_id, updateStepThree)\n\n                break;\n            default:\n                console.log(\"No se encontró ningún stage con ese nombre\");\n                result = \"No se encontró ningún stage con ese nombre\"\n        }\n        return updatedAcceptance;\n    } catch (err) {\n        return err\n    }\n}\n\nconst setAcceptanceById = async (_id, update) => {\n    try {\n        console.log(`id para setAccep ${_id}`);\n        const updateAcceptance = await PjAcceptance\n            .findByIdAndUpdate(_id, update, { new: true });\n        if (updateAcceptance != null) {\n            return updateAcceptance;\n        } else {\n            throw boom.notFound(`Oops!, acta con _id:${_id}, no encontrada`)\n        }\n    } catch (err) {\n        return err;\n    }\n}\n\n\nconst readAcceptanceById = async (_id) => {\n    try {\n        const acceptance = await PjAcceptance\n            .findById(_id);\n        if (acceptance != null) {\n            return acceptance;\n        } else {\n            throw boom.notFound(`Oops!, acta con _id:${_id}, no encontrada`)\n        }\n    } catch (err) {\n        return err;\n    }\n}\n\nconst findSomeStageComplete = async (data, someStageName) => {\n    // const data = await readAcceptanceById(_id);\n    const existingStageComplete = data.stage.some(stageSome => stageSome.name === someStageName && stageSome.completed === true)\n    console.log(`Se encontró el estado ${someStageName} completo en el array`);\n    const result = existingStageComplete === true ? someStageName : false;\n    return result;\n}\n\nconst updateSelectionStage = async (_id, stage) => {\n    //Obtener los datos de la base datos por medio del _id\n    const data = await readAcceptanceById(_id);\n    //Identifica si el registro cumple con el estado buscado\n    const confirmStage = await findSomeStageComplete(data, stage);\n    return confirmStage;\n}\n\nconst getLastStageName = async (data) => {\n    const stages = _.orderBy(data.stage, ['date'], ['desc']);\n    return stages.length > 0 ? stages[0].name : null;\n}\n\n\nconst data = {\n    \"_id\": {\n        \"$oid\": \"643c3c15ae1896e1e634dbb7\"\n    },\n    \"_codeProjectERP\": \"PJ2203-0112\",\n    \"_idProjectERP\": 32,\n    \"dateAcceptance\": {\n        \"$date\": \"2023-01-28T01:00:00Z\"\n    },\n    \"serviceObject\": \"Asistencia tecnica para la instalacion de 5 alarmas\",\n    \"dateInit\": {\n        \"$date\": \"2023-01-28T01:00:00Z\"\n    },\n    \"dateEnd\": {\n        \"$date\": \"2023-01-28T01:00:00Z\"\n    },\n    \"erpRef\": {\n        \"client\": {\n            \"purchaseOrder\": \"oc123456789\"\n        },\n        \"own\": {\n            \"proposal\": \"OF12334567890\"\n        }\n    },\n    \"client\": {\n        \"company\": \"ULTRACEM\",\n        \"Name\": \"Pedro Perez\",\n        \"Position\": \"Jefe de Compras\",\n        \"Email\": \"perdro.perez@prueba.com\"\n    },\n    \"controller\": {\n        \"Position\": \"No especificado\"\n    },\n    \"contractor\": {\n        \"Name\": \"Pedro Perez\",\n        \"Position\": \"Jefe de Compras\",\n        \"Email\": \"perdro.perez@prueba.com\"\n    },\n    \"deliverables\": [{\n        \"_id\": \"uuid\",\n        \"description\": \"Este es entregable 1\",\n        \"compliance\": 100,\n        \"accepted\": true\n    },\n    {\n        \"_id\": \"uuid\",\n        \"description\": \"Este es entregable 2\",\n        \"compliance\": 100,\n        \"accepted\": true\n    }\n    ],\n    \"citySign\": \"Barranquilla\",\n    \"officeSign\": \"el cliente\",\n    \"serviceValue\": 5,\n    \"recommendations\": \"Estas son nuestras recomendaciones\",\n    \"typeAcceptance\": \"Total\",\n    \"stage\": [{\n        \"name\": \"new\",\n        \"date\": {\n            \"$date\": \"2023-04-16T18:19:01.177Z\"\n        },\n        \"completed\": false,\n        \"_id\": {\n            \"$oid\": \"643c3c15ae1896e1e634dbb8\"\n        }\n    },\n    {\n        \"name\": \"rejected\",\n        \"date\": {\n            \"$date\": \"2023-04-16T18:19:01.177Z\"\n        },\n        \"completed\": true,\n        \"_id\": {\n            \"$oid\": \"643c3c15ae1896e1e634dbb8\"\n        }\n    }\n    ],\n    \"_idFiles\": [],\n    \"dateSign\": {\n        \"$date\": \"2023-04-16T18:19:01.186Z\"\n    },\n    \"rejectedMessage\": [],\n    \"createdAt\": {\n        \"$date\": \"2023-04-16T18:19:01.191Z\"\n    },\n    \"updatedAt\": {\n        \"$date\": \"2023-04-16T18:19:01.191Z\"\n    }\n}\n\n\nmodule.exports = { updateDynamicAcceptance, setAcceptanceById, findSomeStageComplete, getLastStageName }"],"mappings":"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"}