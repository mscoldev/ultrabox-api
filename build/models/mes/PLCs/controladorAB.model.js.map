{"version":3,"file":"controladorAB.model.js","names":["boom","require","Controller","bufToArray","ControladorABMES","infoPLC","ipAddress","slot","tagNameArray","limitInputs","limitMaterials","material","PLC","connect","then","descriptionPLC","properties","console","log","materialsData","newUpdateMaterial","map","id","_idControllerMaterial","name","i","lengthData","newTag","dataValue","readTag","bufferAB","Buffer","from","length","value","writeTag","e","error","Error","module","exports"],"sources":["../../../../src/models/mes/PLCs/controladorAB.model.js"],"sourcesContent":["const boom = require('@hapi/boom');\nconst { Controller } = require('st-ethernet-ip');\nconst bufToArray = require('../../../libs/bufToArray.lib');\n\nclass ControladorABMES {\n  constructor(infoPLC) {\n    this.ipAddress = infoPLC.ipAddress; //IP del controlador\n    this.slot = infoPLC.slot; //Slot del controladorSlot del controlador\n    this.tagNameArray = infoPLC.tagNameArray; //tagNameArray del controladorNombre con el que se definió para el canal de entrada de materiales.\n    this.limitInputs = infoPLC.limitInputs; // Numero de canales de entrada.\n    this.limitMaterials = infoPLC.limitMaterials; // Numero maximo de materiales a crear en el controlador.\n    // this.materials = infoPLC.materials;\n  }\n\n  //TODO : Error con crash de la API si la variable del PLC no existe. (Corregir)\n  //! Error potencial si la variable del PLC no existe. (Corregir)\n\n  setValuesToPLC(material) {\n    const PLC = new Controller();\n    PLC.connect(this.ipAddress, this.slot)\n      .then(async () => {\n        const descriptionPLC = PLC.properties;\n        console.log({ descriptionPLC });\n        const ipAddress = this.ipAddress;\n        const tagNameArray = this.tagNameArray; //tagNameArray del controladorNombre con el que se definio para el canal de entrada de materiales.\n        const limitInputs = this.limitInputs; // Numero de canales de entrada. ejemplo: Valvula 1 - 7 (Total: 7)\n        const limitMaterials = this.limitMaterials; // Numero máximo de materiales a crear en el controlador.\n        const materialsData = material;\n        console.log({\n          material,\n          ipAddress,\n          tagNameArray,\n          limitInputs,\n          limitMaterials,\n          materialsData,\n        });\n        const newUpdateMaterial = materialsData.map(async function (material) {\n          const id = material._idControllerMaterial;\n          const name = material.name;\n          console.log({ id, name });\n\n          for (let i = 0; i <= limitInputs; i++) {\n            const lengthData = PLC.newTag(\n              `${tagNameArray}[${i}].MATERIAL[${id}].LEN`\n            );\n            const dataValue = PLC.newTag(\n              `${tagNameArray}[${i}].MATERIAL[${id}].DATA`,\n              null,\n              false,\n              1,\n              15\n            );\n\n            await PLC.readTag(lengthData);\n            await PLC.readTag(dataValue);\n\n            const bufferAB = bufToArray(Buffer.from(name));\n            const length = bufferAB.length;\n\n            dataValue.value = bufferAB;\n            lengthData.value = length;\n\n            await PLC.writeTag(lengthData);\n            await PLC.writeTag(dataValue);\n          }\n        });\n        console.log(`Valores Actualizados en PLC con exito.`);\n        return descriptionPLC;\n      })\n      .catch(async (e) => {\n        console.error(e);\n        throw new Error('No se pudo conectar al PLC');\n      });\n  }\n}\n\nmodule.exports = { ControladorABMES };\n"],"mappings":"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"}