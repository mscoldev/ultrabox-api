{"version":3,"file":"upload.controller.js","names":["require","response","request","multer","path","fs","File","config","storage","diskStorage","destination","req","file","cb","query","app","codeProject","uploadPath","join","ensureDirSync","filename","Date","now","originalname","storageMul","upload","single","uploads","array","uploadFile","res","next","err","MulterError","status","json","save","fileSaved","send","uploadFiles","files","filesSaved","Promise","all","map","newFile","push","then","module","exports"],"sources":["../../src/controllers/upload.controller.js"],"sourcesContent":["const { response, request } = require('express');\nconst multer = require('multer');\nconst path = require('path');\nconst fs = require('fs-extra');\nconst File = require('../models/tools/file.model')\nrequire('dotenv').config();\n\nconst storage = multer.diskStorage({\n    destination: (req, file, cb) => {\n        const { app = \"\", codeProject = \"\" } = req.query;\n        const uploadPath = path.join('uploads', 'files');\n        fs.ensureDirSync(uploadPath);\n        cb(null, uploadPath);\n    },\n    filename: (req, file, cb) => {\n        cb(null, Date.now() + '-' + file.originalname);\n    }\n});\n\nconst storageMul = multer.diskStorage({\n    destination: (req, file, cb) => {\n        const { app = \"\", codeProject = \"\" } = req.query;\n        const uploadPath = path.join('uploads', app, codeProject);\n        fs.ensureDirSync(uploadPath);\n        cb(null, uploadPath);\n    },\n    filename: (req, file, cb) => {\n        cb(null, Date.now() + '-' + file.originalname);\n    }\n});\n\nconst upload = multer({ storage: storage }).single('file');\nconst uploads = multer({ storage: storageMul }).array('files');\n\nfunction uploadFile(req = request, res = response, next) {\n    upload(req, res, async function(err) {\n        if (err instanceof multer.MulterError) {\n            return res.status(500).json(err)\n        } else if (err) {\n            return res.status(500).json(err)\n        }\n\n        const file = new File(req.file);\n        const fileSaved = await file.save()\n        return res.status(200).send(fileSaved)\n    })\n}\n\nasync function uploadFiles(req = request, res = response, next) {\n    uploads(req, res, function(err) {\n        if (err instanceof multer.MulterError) {\n            return res.status(500).json(err);\n        } else if (err) {\n            return res.status(500).json(err);\n        }\n        const files = req.files;\n        const filesSaved = [];\n        Promise.all(\n                files.map(async(file) => {\n                    let newFile = new File(file);\n                    const fileSaved = await newFile.save();\n                    filesSaved.push(fileSaved);\n                })\n            )\n            .then(() => {\n                return res.status(200).send(filesSaved);\n            })\n            .catch((err) => {\n                return res.status(500).json(err);\n            });\n    });\n}\nmodule.exports = {\n    uploadFile,\n    uploadFiles\n}"],"mappings":"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"}