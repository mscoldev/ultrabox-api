{"version":3,"file":"acceptance.controller.js","names":["require","response","request","boom","Types","PjAcceptance","updateDynamicAcceptance","setAcceptanceById","findSomeStageComplete","getAcceptanceById","req","res","next","query","_id","_codeProjectERP","undefined","badRequest","findOne","$or","populate","path","model","acceptance","status","json","msg","notFound","setAcceptance","stage","Date","now","body","signatory","data","newAcceptance","save","acceptanceSaved","console","log","updateAcceptanceById","serviceValue","recommendations","rejectedMessage","ObjectId","params","RejectedMessage","$push","updatedAcceptance","module","exports"],"sources":["../../../src/controllers/projects/acceptance.controller.js"],"sourcesContent":["const { response, request } = require(\"express\");\nconst boom = require('@hapi/boom');\nconst { Types } = require('mongoose');\nconst PjAcceptance = require(\"../../models/projects/acceptance.model\");\n\nconst { updateDynamicAcceptance, setAcceptanceById, findSomeStageComplete } = require('../../helpers/validators/projects/stages')\n\n\n\n\nconst getAcceptanceById = async(req = request, res = response, next) => {\n    try {\n        const { _id, _codeProjectERP } = req.query;\n        if (_id == undefined & _codeProjectERP == undefined) {\n            throw boom.badRequest('Debe definir mínimo un parámetro de consulta: _id o _codeProjectERP')\n        } else {\n            //*Aquí buscamos en la base de datos por cualquiera de los dos parámetros.\n            const acceptance = await PjAcceptance\n                .findOne({ $or: [{ _codeProjectERP }, { _id }] })\n                .populate({ path: '_idFiles', model: 'File' })\n            if (acceptance != null) {\n                res.status(200).json({\n                    msg: 'Acta de aceptación',\n                    acceptance\n                })\n            } else {\n                throw boom.notFound(`Oops!, no se encontraron actas con alguno de los parámetros de búsqueda ingresados.`)\n            }\n        }\n    } catch (err) {\n        next(err);\n    }\n}\n\n\n\nconst setAcceptance = async(req = request, res = response, next) => {\n    //* Crear un acta por medio del formulario y asignar por defecto la condición de \"new\". No permitir el ingreso de firmas en el primer estado.\n\n    try {\n        const stage = { \"name\": \"new\", \"date\": Date.now(), \"completed\": true }\n        const { signatory, ...data } = req.body;\n        data['stage'] = stage;\n        const newAcceptance = new PjAcceptance(data);\n        const acceptanceSaved = await newAcceptance.save();\n        console.log(acceptanceSaved);\n        res.status(200).json({\n            msg: 'Nueva acta de aceptación de proyecto almacenada',\n            acceptanceSaved\n        });\n\n    } catch (err) {\n        next(err);\n    }\n}\n\n\n//TODO: Implementar actualizacion general de acta sin mensajes de rechazo.\n//TODO: Implementra cambios de estado del acta automatizados desde el backend.\n\n\nconst updateAcceptanceById = async(req = request, res = response, next) => {\n    try {\n        const body = req.body\n        const { stage, signatory, serviceValue, recommendations } = req.body\n        const { rejectedMessage } = body\n        const _id = Types.ObjectId(req.params._id);\n\n        //* Si el Stage del acta es new se reciben los datos para la firma por parte del contractor.\n        //* las otros datos no se tienen en cuenta, debe verificarse el si stage es rejected al momento te recibir\n        //* de ser asi, se almacena el rejectedMessage.description y el stage tendría un rejected\n\n        //TODO: Terminar de validar el caso de mensajes rechazados.\n        // const description = data ?.rejectedMessage ?.description\n        // const a = typeof description === 'string';\n\n        if (rejectedMessage) {\n            const RejectedMessage = {\n                $push: {\n                    rejectedMessage: rejectedMessage,\n                }\n            };\n            const updatedAcceptance = await setAcceptanceById(_id, RejectedMessage, serviceValue, recommendations);\n            console.log(\"Activado rejected\");\n            res.status(200).json({\n                msg: 'Acta actualizada',\n                updatedAcceptance\n            })\n        } else {\n            const updatedAcceptance = await updateDynamicAcceptance(_id, signatory, serviceValue, recommendations);\n            console.log(\"Activado updated\");\n            res.status(200).json({\n                msg: 'Acta actualizada',\n                updatedAcceptance\n            })\n        }\n    } catch (err) {\n        next(err);\n    }\n}\n\n\nmodule.exports = {\n    setAcceptance,\n    getAcceptanceById,\n    updateAcceptanceById,\n}"],"mappings":"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"}